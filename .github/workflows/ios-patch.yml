name: iOS Patch (Shorebird)
on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'The release version to patch (e.g. 1.0.0+8)'
        required: true
      track:
        description: 'Target track'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - stable
jobs:
  patch:
    runs-on: macos-26
    env:
      SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
      APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
      CERTIFICATE_PRIVATE_KEY: ${{ secrets.CERTIFICATE_PRIVATE_KEY }}
    steps:
      - uses: actions/checkout@v4
      - name: Read Flutter version from .mise.toml
        id: mise
        run: echo "flutter_version=$(grep 'flutter' .mise.toml | sed 's/.*= *\"//' | sed 's/\"//')" >> "$GITHUB_OUTPUT"
      - uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ steps.mise.outputs.flutter_version }}
          cache: true
      - name: Install Codemagic CLI Tools
        run: |
          pipx install codemagic-cli-tools
          pipx ensurepath
      - name: Setup Firebase config
        run: echo "${{ secrets.GOOGLE_SERVICE_INFO_PLIST_BASE64 }}" | base64 -d > apps/mobile/ios/Runner/GoogleService-Info.plist
      - run: flutter pub get
        working-directory: apps/mobile
      - run: dart analyze .
        working-directory: apps/mobile
      - run: flutter test
        working-directory: apps/mobile
      - name: Fetch signing files
        run: |
          app-store-connect fetch-signing-files com.k9i.ccpocket \
            --type IOS_APP_STORE --create
      - name: Setup keychain
        run: keychain initialize
      - name: Add certs to keychain
        run: keychain add-certificates
      - name: Set up code signing
        run: xcode-project use-profiles
      - name: Shorebird Patch iOS
        working-directory: apps/mobile
        run: |
          # --no-tree-shake-icons: Keep MaterialIcons font stable across release/patch builds.
          # TODO: Remove once Shorebird supports asset patching (https://github.com/shorebirdtech/shorebird/issues/318)
          shorebird patch ios \
            --release-version=${{ inputs.release_version }} \
            --track=${{ inputs.track }} \
            --export-options-plist=$HOME/export_options.plist \
            -- --no-tree-shake-icons
