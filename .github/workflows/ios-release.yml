name: iOS Release (Shorebird)
on:
  workflow_dispatch: {}
jobs:
  release:
    runs-on: macos-15
    env:
      SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
      APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
      APP_STORE_CONNECT_KEY_IDENTIFIER: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
      APP_STORE_CONNECT_PRIVATE_KEY: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
      CERTIFICATE_PRIVATE_KEY: ${{ secrets.CERTIFICATE_PRIVATE_KEY }}
    steps:
      - uses: actions/checkout@v4
      - uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.41.1'
          cache: true
      - name: Install Codemagic CLI Tools
        run: pip3 install codemagic-cli-tools
      - run: flutter pub get
        working-directory: apps/mobile
      - run: dart analyze .
        working-directory: apps/mobile
      - run: flutter test
        working-directory: apps/mobile
      - name: Fetch signing files
        run: |
          app-store-connect fetch-signing-files "$BUNDLE_ID" \
            --type IOS_APP_STORE --create
        env:
          BUNDLE_ID: com.k9i.ccpocket
      - name: Setup keychain
        run: keychain initialize
      - name: Add certs to keychain
        run: keychain add-certificates
      - name: Set up code signing
        run: xcode-project use-profiles
      - name: Shorebird Release iOS
        working-directory: apps/mobile
        run: |
          shorebird release ios \
            --flutter-version="3.41.1" \
            --export-options-plist=/Users/runner/export_options.plist
      - name: Upload to TestFlight
        uses: apple-actions/upload-testflight-build@v3
        with:
          app-path: apps/mobile/build/ios/ipa/*.ipa
          issuer-id: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          api-key-id: ${{ secrets.APP_STORE_CONNECT_KEY_IDENTIFIER }}
          api-private-key: ${{ secrets.APP_STORE_CONNECT_PRIVATE_KEY }}
