name: Android Release (Shorebird)
on:
  push:
    tags:
      - 'android/v*'
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    env:
      SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      - name: Read Flutter version from .mise.toml
        id: mise
        run: echo "flutter_version=$(grep 'flutter' .mise.toml | sed 's/.*= *\"//' | sed 's/\"//')" >> "$GITHUB_OUTPUT"
      - uses: shorebirdtech/setup-shorebird@v1
        with:
          cache: true
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ steps.mise.outputs.flutter_version }}
          cache: true
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - uses: gradle/gradle-build-action@v3
      # Android signing: decode keystore from base64 secret
      - name: Setup Android signing
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > apps/mobile/android/keystore.jks
          cat > apps/mobile/android/keystore.properties << EOF
          storeFile=${{ github.workspace }}/apps/mobile/android/keystore.jks
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          EOF
      - name: Setup Firebase config
        run: echo "${{ secrets.GOOGLE_SERVICES_JSON_BASE64 }}" | base64 -d > apps/mobile/android/app/google-services.json
      - run: flutter pub get
        working-directory: apps/mobile
      - run: dart analyze .
        working-directory: apps/mobile
      - run: flutter test
        working-directory: apps/mobile
      - name: Shorebird Release Android
        working-directory: apps/mobile
        # --no-tree-shake-icons: Prevent MaterialIcons-Regular.otf from changing
        # between release and patch builds, which causes Shorebird asset diff warnings
        # and prevents patches from being applied on devices.
        # TODO: Remove once Shorebird supports asset patching (https://github.com/shorebirdtech/shorebird/issues/318)
        run: shorebird release android --flutter-version="${{ steps.mise.outputs.flutter_version }}" -- --no-tree-shake-icons
      - name: Upload to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GCLOUD_SERVICE_ACCOUNT_CREDENTIALS }}
          packageName: com.k9i.ccpocket
          releaseFiles: apps/mobile/build/app/outputs/bundle/release/*.aab
          track: internal
          status: draft

      # GitHub Release (only when triggered by tag push)
      - name: Extract version from tag
        if: startsWith(github.ref, 'refs/tags/')
        id: version
        run: echo "version=${GITHUB_REF_NAME#android/v}" >> "$GITHUB_OUTPUT"
      - name: Extract changelog section
        if: startsWith(github.ref, 'refs/tags/')
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SEMVER="${VERSION%%+*}"
          NOTES=$(awk "/^## \\[${SEMVER}\\]/{found=1; next} /^## \\[/{if(found) exit} found{print}" CHANGELOG.md)
          {
            echo "notes<<EOF"
            echo "$NOTES"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ github.token }}
          RELEASE_NOTES: ${{ steps.changelog.outputs.notes }}
        run: |
          printf '%s\n' "$RELEASE_NOTES" > /tmp/release_notes.md
          gh release create "$GITHUB_REF_NAME" \
            --title "Android ${{ steps.version.outputs.version }}" \
            --notes-file /tmp/release_notes.md
